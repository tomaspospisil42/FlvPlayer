/*!
 * FlvPlayer.js v1.1.8
 * Github: https://github.com/zhw2590582/FlvPlayer#readme
 * (c) 2017-2020 Harvey Zack
 * Released under the MIT License.
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).FlvplayerDecoder=t()}(this,(function(){"use strict";var e=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function t(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}var n=function(e,n,r){return n&&t(e.prototype,n),r&&t(e,r),e};function r(e,t){return e(t={exports:{}},t.exports),t.exports}var o=r((function(e){function t(n,r){return e.exports=t=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},t(n,r)}e.exports=t}));var i=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&o(e,t)},a=r((function(e){function t(n){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?e.exports=t=function(e){return typeof e}:e.exports=t=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t(n)}e.exports=t}));var u=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e};var s=function(e,t){return!t||"object"!==a(t)&&"function"!=typeof t?u(e):t},f=r((function(e){function t(n){return e.exports=t=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},t(n)}e.exports=t}));function c(){return performance&&"function"==typeof performance.now?performance.now():Date.now()}function d(e){var t=0,n=c();return function(r){t+=r;var o=c(),i=o-n;i>=1e3&&(e(t/i*1e3),n=o,t=0)}}var p=function(){function t(n,r){var o=this;e(this,t),this.flv=n;var i=n.options,a=n.player,u=n.debug;this.ready=!1,this.playing=!1,this.playIndex=0,this.videoframes=[],this.timestamps=[],this.videoInputLength=0,this.videoOutputLength=0,this.decoding=!1,this.byteSize=0,this.loaded=0,this.decoderRate=d((function(e){n.emit("decoderRate",e)})),this.drawRate=d((function(e){n.emit("drawRate",e)})),n.on("destroy",(function(){o.videoframes=[],o.timestamps=[],o.decoderWorker.terminate(),o.decoderWorker=null,o.stop()})),n.on("befoerdecoding",(function(e){i.live&&i.hasAudio&&!o.playing&&o.timestamps.length>=a.frameRate&&o.timestamps.shift(),o.timestamps.push(e),o.decoding=!0,o.videoInputLength+=1})),n.on("decoding",(function(e,t){i.live&&i.hasAudio&&!o.playing&&o.timestamps.length>=a.frameRate&&o.videoframes.shift(),o.videoframes.push(e),o.byteSize+=t,o.videoOutputLength+=1,o.decoding=o.videoInputLength!==o.videoOutputLength,o.loaded=o.videoOutputLength/a.frameRate,n.emit("videoLoaded",o.loaded),o.decoderRate(1),o.ready||1!==o.videoOutputLength||(o.ready=!0,i.live&&(r.currentTime=o.timestamps[0]/1e3),n.emit("ready"))})),n.on("timeupdate",(function(e){var t=o.playIndex,a=o.timestamps[t];if(void 0!==a&&1e3*e>=a)if(o.draw(t)){var s=o.getFramesSize(t);(i.live||!i.cache)&&s>=64*i.videoChunk&&o.videoframes.length-1>t&&o.timestamps.length-1>t?(o.playIndex=0,o.videoframes.splice(0,t+1),o.timestamps.splice(0,t+1),r.currentTime=o.timestamps[0]/1e3,u.log("free-video-memory",{total:o.byteSize,yuv:s,index:t}),n.emit("freeVideoMemory",s,t)):o.playIndex+=1}else i.live||o.stop()}))}return n(t,[{key:"draw",value:function(e){var t=this.videoframes[e];return!!t&&(this.renderer.drawFrame(t),this.drawRate(1),!0)}},{key:"play",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.playing=!0,this.flv.options.live?(this.playIndex=0,this.flv.decoder.currentTime=(this.timestamps[0]||0)/1e3):this.playIndex=this.timestamps.findIndex((function(t){return t>=1e3*e}))}},{key:"stop",value:function(){this.playing=!1,this.flv.options.live&&(this.playIndex=0)}}]),t}();function l(e){this.canvasElement=e,this.contextGL&&this.initProgram()}function h(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=f(e);if(t){var o=f(this).constructor;n=Reflect.construct(r,arguments,o)}else n=r.apply(this,arguments);return s(this,n)}}return l.prototype.drawFrame=function(e){var t=e.width,n=e.height,r=e.data;this.drawNextOuptutPictureRGBA(t,n,null,new Uint8Array(r))},l.prototype.drawNextOuptutPictureRGBA=function(e,t,n,r){var o=r,i=this.canvasElement.getContext("2d"),a=i.getImageData(0,0,e,t);a.data.set(o),i.putImageData(a,0,0)},function(t){i(o,t);var r=h(o);function o(t,n){var i;e(this,o),i=r.call(this,t,n);var a=t.player;t.events;return i.renderer=new l(a.$canvas),t.on("fsVideoData",(function(e,n){t.emit("befoerdecoding",n),t.emit("decoding",e,e.data.byteLength)})),i}return n(o,[{key:"getFramesSize",value:function(e){for(var t=0,n=0;n<e;n++)t+=this.videoframes[n].data.byteLength;return t}}]),o}(p)}));
